<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì£¼ê°€ ì°¨íŠ¸ - ë„¤ì´ë²„ ìŠ¤íƒ€ì¼</title>

    <!-- SockJS / STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Chart.js + ì‹œê°„ ì–´ëŒ‘í„°(Luxon) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1/dist/chartjs-adapter-luxon.umd.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans KR', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f6f8;
        }
        .page {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* ìƒë‹¨ ì¢…ëª© ìš”ì•½ ì˜ì—­ (ë„¤ì´ë²„ ëŠë‚Œ) */
        .quote-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #ffffff;
            border: 1px solid #e3e5e8;
            border-radius: 12px;
            padding: 18px 22px;
            margin-bottom: 16px;
        }
        .quote-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .stock-name {
            font-size: 24px;
            font-weight: 700;
        }
        .stock-code {
            font-size: 14px;
            color: #666;
        }
        .quote-right {
            text-align: right;
        }
        .price-now {
            font-size: 32px;
            font-weight: 700;
        }
        .price-change {
            margin-top: 4px;
            font-size: 14px;
        }
        .price-up {
            color: #d60000;
        }
        .price-down {
            color: #0051c7;
        }
        .price-flat {
            color: #333;
        }

        .quote-extra {
            display: flex;
            margin-top: 8px;
            gap: 16px;
            font-size: 13px;
            color: #555;
        }
        .quote-extra span.label {
            color: #888;
            margin-right: 4px;
        }

        /* íƒ­ ì˜ì—­ (1ì¼, 1ì£¼ ... UIë§Œ) */
        .chart-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
            margin-top: 6px;
            font-size: 13px;
        }
        .chart-tabs button {
            border: 1px solid #e3e5e8;
            background: #f7f7f9;
            border-radius: 14px;
            padding: 4px 10px;
            cursor: pointer;
        }
        .chart-tabs button.active {
            background: #03c75a;
            border-color: #03c75a;
            color: #fff;
            font-weight: 600;
        }

        /* ì¢…ëª© ì„ íƒ ì˜ì—­ */
        .control-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .control-bar select {
            padding: 4px 8px;
            font-size: 14px;
        }

        /* ì°¨íŠ¸ ì˜ì—­ ì¹´ë“œ */
        .chart-card {
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid #e3e5e8;
            padding: 16px 20px 22px;
        }

        canvas {
            width: 100% !important;
            height: 360px !important;
        }
    </style>
</head>
<body>
<div class="page">

    <!-- ìƒë‹¨ ì¢…ëª© ìš”ì•½ -->
    <div class="quote-header">
        <div class="quote-left">
            <div class="stock-name" id="stockName">SKí•˜ì´ë‹‰ìŠ¤</div>
            <div class="stock-code" id="stockCode">000660 Â· ì½”ìŠ¤í”¼</div>

            <div class="quote-extra">
                <div><span class="label">ê¸°ì¤€ê°€</span><span id="basePrice">-</span></div>
                <div><span class="label">ì‹œê°€</span><span id="openPrice">-</span></div>
                <div><span class="label">ê³ ê°€</span><span id="highPrice">-</span></div>
                <div><span class="label">ì €ê°€</span><span id="lowPrice">-</span></div>
            </div>
        </div>

        <div class="quote-right">
            <div class="price-now" id="currentPrice">0</div>
            <div class="price-change price-flat" id="changeInfo">
                0 (0.00%)
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì¹´ë“œ -->
    <div class="chart-card">

        <!-- íƒ­ / ì»¨íŠ¸ë¡¤ -->
        <div class="control-bar">
            <span>ğŸ“Œ ì¢…ëª© ì„ íƒ:</span>
            <select id="symbolSelect">
                <option value="000660">SKí•˜ì´ë‹‰ìŠ¤ (000660)</option>
                <option value="005930">ì‚¼ì„±ì „ì (005930)</option>
                <option value="450080">ì—ì½”í”„ë¡œë¨¸í‹° (450080)</option>
            </select>
        </div>

        <div class="chart-tabs">
            <button class="active">1ì¼</button>
            <button disabled>1ì£¼</button>
            <button disabled>3ê°œì›”</button>
            <button disabled>1ë…„</button>
        </div>

        <!-- ì°¨íŠ¸ -->
        <canvas id="priceChart"></canvas>
    </div>
</div>

<script>
    // ------------------------------
    // ì „ì—­ ìƒíƒœ
    // ------------------------------
    let stompClient = null;
    let subscription = null;

    const state = {
        basePrice: null,   // ê¸°ì¤€ê°€ (ì§€ê¸ˆì€ "ì²« í‹±"ì„ ê¸°ì¤€ê°€ì²˜ëŸ¼ ì‚¬ìš©)
        openPrice: null,
        highPrice: null,
        lowPrice: null
    };

    // ------------------------------
    // Chart.js ì„¤ì •
    // ------------------------------
    const ctx = document.getElementById("priceChart").getContext("2d");

    const priceChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label: "ê°€ê²©",
                data: [],
                borderColor: "#2e8de5",
                backgroundColor: "rgba(46,141,229,0.08)",
                borderWidth: 1.8,
                pointRadius: 0,      // ì  ì—†ì• ê¸°
                tension: 0.25        // ê³¡ì„  ë¶€ë“œëŸ½ê²Œ
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: (ctx) => ` ${ctx.parsed.y.toLocaleString()}ì›`
                    }
                }
            },
            scales: {
                x: {
                    type: "time",
                    time: {
                        unit: "minute",
                        tooltipFormat: "HH:mm:ss"
                    },
                    grid: {
                        color: "#eeeeee"
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 8
                    }
                },
                y: {
                    grid: {
                        color: "#f1f1f1"
                    },
                    ticks: {
                        callback: (value) => value.toLocaleString()
                    }
                }
            }
        }
    });

    // ------------------------------
    // WebSocket / STOMP ì—°ê²°
    // ------------------------------
    function connectWs() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            console.log("STOMP connected");
            const defaultSymbol = document.getElementById("symbolSelect").value;
            subscribeSymbol(defaultSymbol);
            loadInitialPrice(defaultSymbol);
        });
    }

    // ------------------------------
    // ì‹¬ë³¼ë³„ êµ¬ë…
    // ------------------------------
    function subscribeSymbol(symbol) {
        if (subscription) {
            subscription.unsubscribe();
        }

        resetChartAndState();

        subscription = stompClient.subscribe(`/topic/price.${symbol}`, (message) => {
            const tick = JSON.parse(message.body);
            handleTick(tick);
        });

        updateHeaderSymbol(symbol);
    }

    // ------------------------------
    // ì´ˆê¸° 1ë²ˆ RESTë¡œ í˜„ì¬ê°€ ê°€ì ¸ì˜¤ê¸°
    // ------------------------------
    async function loadInitialPrice(symbol) {
        try {
            const res = await fetch(`/api/price/${symbol}`);
            if (!res.ok) return;
            const tick = await res.json();
            if (tick && tick.price) {
                handleTick(tick, true);
            }
        } catch (e) {
            console.error("initial load error", e);
        }
    }

    // ------------------------------
    // ê°€ê²© í‹± ì²˜ë¦¬ (ë„¤ì´ë²„ ìŠ¤íƒ€ì¼)
    // ------------------------------
    function handleTick(tick, isInitial = false) {
        const price = tick.price;
        const ts = new Date(tick.timestamp);

        if (state.basePrice == null) {
            // ì²« ë²ˆì§¸ ìˆ˜ì‹  ê°€ê²©ì„ ê¸°ì¤€ê°€/ì‹œê°€ë¡œ ì‚¬ìš© (ì‹¤ì œë¡œëŠ” ì „ì¼ ì¢…ê°€ë¥¼ ë„£ëŠ”ê²Œ ë§ìŒ)
            state.basePrice = price;
            state.openPrice = price;
            state.highPrice = price;
            state.lowPrice = price;
        } else {
            // ê³ ê°€/ì €ê°€ ê°±ì‹ 
            if (price > state.highPrice) state.highPrice = price;
            if (price < state.lowPrice) state.lowPrice = price;
        }

        // ì°¨íŠ¸ì— ë°ì´í„° ì¶”ê°€
        priceChart.data.labels.push(ts);
        priceChart.data.datasets[0].data.push(price);

        // ë„ˆë¬´ ë§ì•„ì§€ë©´ ì•ìª½ ì œê±° (ë©”ëª¨ë¦¬/ì„±ëŠ¥)
        const MAX_POINTS = 600; // ì•½ 20ë¶„ (2ì´ˆ x 600)
        if (priceChart.data.labels.length > MAX_POINTS) {
            priceChart.data.labels.shift();
            priceChart.data.datasets[0].data.shift();
        }

        priceChart.update("none"); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸

        // í—¤ë” ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
        updateHeaderPrice(price);
    }

    // ------------------------------
    // UI ì—…ë°ì´íŠ¸
    // ------------------------------
    function updateHeaderSymbol(symbol) {
        const nameEl = document.getElementById("stockName");
        const codeEl = document.getElementById("stockCode");

        if (symbol === "000660") {
            nameEl.textContent = "SKí•˜ì´ë‹‰ìŠ¤";
        } else if (symbol === "005930") {
            nameEl.textContent = "ì‚¼ì„±ì „ì";
        } else {
            nameEl.textContent = symbol;
        }
        codeEl.textContent = `${symbol} Â· ì½”ìŠ¤í”¼`;
    }

    function updateHeaderPrice(price) {
        const currentEl = document.getElementById("currentPrice");
        const changeEl = document.getElementById("changeInfo");
        const baseEl = document.getElementById("basePrice");
        const openEl = document.getElementById("openPrice");
        const highEl = document.getElementById("highPrice");
        const lowEl = document.getElementById("lowPrice");

        currentEl.textContent = price.toLocaleString();

        if (state.basePrice != null) {
            const diff = price - state.basePrice;
            const rate = state.basePrice === 0 ? 0 : (diff / state.basePrice) * 100;

            let cls = "price-flat";
            let sign = "";
            if (diff > 0) {
                cls = "price-up";
                sign = "+";
            } else if (diff < 0) {
                cls = "price-down";
            }

            changeEl.className = "price-change " + cls;
            changeEl.textContent =
                `${sign}${diff.toLocaleString()} (${sign}${rate.toFixed(2)}%)`;
        }

        baseEl.textContent  = state.basePrice  != null ? state.basePrice.toLocaleString()  : "-";
        openEl.textContent  = state.openPrice  != null ? state.openPrice.toLocaleString()  : "-";
        highEl.textContent  = state.highPrice  != null ? state.highPrice.toLocaleString()  : "-";
        lowEl.textContent   = state.lowPrice   != null ? state.lowPrice.toLocaleString()   : "-";
    }

    function resetChartAndState() {
        // ìƒíƒœ ì´ˆê¸°í™”
        state.basePrice = null;
        state.openPrice = null;
        state.highPrice = null;
        state.lowPrice = null;

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        priceChart.data.labels = [];
        priceChart.data.datasets[0].data = [];
        priceChart.update("none");

        document.getElementById("currentPrice").textContent = "0";
        const changeEl = document.getElementById("changeInfo");
        changeEl.className = "price-change price-flat";
        changeEl.textContent = "0 (0.00%)";

        document.getElementById("basePrice").textContent = "-";
        document.getElementById("openPrice").textContent = "-";
        document.getElementById("highPrice").textContent = "-";
        document.getElementById("lowPrice").textContent = "-";
    }

    // ------------------------------
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // ------------------------------
    document.getElementById("symbolSelect").addEventListener("change", (e) => {
        const symbol = e.target.value;
        subscribeSymbol(symbol);
        loadInitialPrice(symbol);
    });

    // ------------------------------
    // ì´ˆê¸° ì‹¤í–‰
    // ------------------------------
    connectWs();
</script>

</body>
</html>
