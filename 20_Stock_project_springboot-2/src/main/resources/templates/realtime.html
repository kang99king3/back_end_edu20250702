<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실시간 주가 차트</title>

    <!-- SockJS / STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Chart.js + time scale adapter (Luxon) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .page {
            max-width: 1100px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            padding: 20px 24px 30px;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .title {
            font-size: 20px;
            font-weight: 600;
        }

        .symbol-select {
            font-size: 14px;
            padding: 6px 8px;
        }

        .price-panel {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 16px;
        }

        .price-main {
            font-size: 28px;
            font-weight: 700;
        }

        .price-change {
            font-size: 14px;
        }

        .price-change.up {
            color: #d60000;
        }

        .price-change.down {
            color: #0051c7;
        }

        .price-meta {
            font-size: 12px;
            color: #666;
        }

        .chart-container {
            width: 100%;
            height: 420px;   /* 네이버처럼 넉넉하게, 예전보다 조금 줄인 크기 */
        }

        #priceChart {
            width: 100%;
            height: 100%;
        }

        .status-bar {
            margin-top: 8px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
<div class="page">

    <!-- 상단 제목 + 종목 선택 -->
    <div class="header-row">
        <div class="title">실시간 주가 차트</div>
        <div>
            <label for="symbol">종목 선택: </label>
            <select id="symbol" class="symbol-select">
                <option value="005930">삼성전자 (005930)</option>
                <option value="000660">SK하이닉스 (000660)</option>
                <option value="450080">에코프로머티 (450080)</option>
            </select>
        </div>
    </div>

    <!-- 현재가 정보 (네이버 상단 느낌) -->
    <div class="price-panel">
        <div id="priceMain" class="price-main">-</div>
        <div id="priceChange" class="price-change">-</div>
        <div id="priceMeta" class="price-meta">-</div>
    </div>

    <!-- 차트 영역 -->
    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>

    <div id="status" class="status-bar">연결 대기 중...</div>
</div>

<script>
    let stompClient = null;
    let currentSubscription = null;

    const statusEl = document.getElementById('status');
    const symbolSelect = document.getElementById('symbol');

    const priceMainEl = document.getElementById('priceMain');
    const priceChangeEl = document.getElementById('priceChange');
    const priceMetaEl = document.getElementById('priceMeta');

    // Chart.js 데이터 구조
    const ctx = document.getElementById('priceChart').getContext('2d');
    const chartData = {
        labels: [],     // x축: 시간
        datasets: [{
            label: '체결가',
            data: [],   // y값들
            borderWidth: 1.5,
            tension: 0.1,
            pointRadius: 0,          // 점 안 보이게
        }]
    };

    const chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'minute',
                        displayFormats: {
                            minute: 'HH:mm'
                        }
                    },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true
                    },
                    grid: {
                        display: true,
                        drawOnChartArea: false
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        // 보기 좋게 자동
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // ----------------------------
    // WebSocket 연결
    // ----------------------------
    function connectWs() {
        const socket = new SockJS('/ws');  // WebSocketConfig의 엔드포인트와 일치해야 함
        stompClient = Stomp.over(socket);

        // 콘솔 로그만, 디버깅 안 하고 조용히
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            statusEl.textContent = 'WebSocket 연결 완료';
            console.log('STOMP connected:', frame);

            // 현재 선택된 종목부터 구독
            subscribeSymbol(symbolSelect.value);

        }, function (error) {
            console.error('STOMP error:', error);
            statusEl.textContent = '연결 끊김: ' + error;
        });
    }

    // ----------------------------
    // 종목별 구독
    // ----------------------------
    function subscribeSymbol(symbol) {

        if (!stompClient || !stompClient.connected) {
            console.log('STOMP not connected yet');
            return;
        }

        // 기존 구독 해제
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }

        const topic = '/topic/price.' + symbol;
        console.log('Subscribe to', topic);
        statusEl.textContent = '구독 중: ' + topic;

        // 기존 차트 데이터 초기화
        chartData.labels.length = 0;
        chartData.datasets[0].data.length = 0;
        chart.update('none');

        // WebSocket 구독
        currentSubscription = stompClient.subscribe(topic, function (message) {
        	console.log("구독 실행")
            try {
                const tick = JSON.parse(message.body);
                console.log("data:",message);
                handleTick(tick);
            } catch (e) {
                console.error('Parse error:', e, message.body);
            }
        });
    }

    // ----------------------------
    // 틱 처리 (차트 + 상단 가격정보)
    // ----------------------------
    function handleTick(tick) {
        // 서버에서 오는 필드 이름을 유연하게 처리
        const price = tick.price ?? tick.lastPrice ?? tick.close;
        if (price == null || isNaN(price)) {
            return; // 가격이 없으면 그리지 않음
        }

        const tsMs = tick.ts ?? tick.timestamp ?? Date.now();
        const ts = new Date(tsMs);

        // 차트 데이터 push
        chartData.labels.push(ts);
        chartData.datasets[0].data.push(price);

        // 최근 240포인트(약 4분 @2초간격)만 유지
        const MAX_POINTS = 240;
        if (chartData.labels.length > MAX_POINTS) {
            chartData.labels.shift();
            chartData.datasets[0].data.shift();
        }

        chart.update('none'); // 애니메이션 없이 즉시 업데이트

        // 상단 가격 패널 업데이트
        updatePricePanel(price, ts, tick);
    }

    function updatePricePanel(price, ts, tick) {
        priceMainEl.textContent = price.toLocaleString('ko-KR');

        // tick에 전일종가(preClose)나 대비 값이 있으면 사용,
        // 없으면 여기서는 그냥 "실시간" 정도만 표시
        const preClose = tick.preClose ?? tick.prevClose;
        let changeText = '';
        let cls = 'price-change';

        if (preClose != null && !isNaN(preClose)) {
            const diff = price - preClose;
            const rate = (diff / preClose) * 100;
            const sign = diff > 0 ? '+' : (diff < 0 ? '-' : '');
            const absDiff = Math.abs(diff).toLocaleString('ko-KR');
            const absRate = Math.abs(rate).toFixed(2);

            changeText = `${sign}${absDiff} (${sign}${absRate}%)`;

            if (diff > 0) cls += ' up';
            else if (diff < 0) cls += ' down';
        } else {
            changeText = '실시간 체결';
        }

        priceChangeEl.className = cls;
        priceChangeEl.textContent = changeText;

        const timeStr = ts.toLocaleTimeString('ko-KR', {hour12: false});
        priceMetaEl.textContent = `갱신 시각: ${timeStr}`;
    }

    // ----------------------------
    // 이벤트 바인딩
    // ----------------------------
    symbolSelect.addEventListener('change', function (e) {
        const symbol = e.target.value;
        subscribeSymbol(symbol);
    });

    // 페이지 로드 후 WebSocket 연결
    connectWs();
</script>
</body>
</html>
